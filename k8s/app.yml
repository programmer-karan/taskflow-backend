# --- Configuration ---
apiVersion: v1
kind: ConfigMap
metadata:
  name: taskflow-config
data:
  DATABASE_URL: "postgresql+asyncpg://postgres:password@postgres-service:5432/taskflow"
  REDIS_URL: "redis://redis-service:6379/0"
  
  # NEW: Point to the MinIO Service
  MINIO_ENDPOINT: "http://minio-service:9000"
  MINIO_ROOT_USER: "minioadmin"
  MINIO_ROOT_PASSWORD: "minioadmin"
  MINIO_BUCKET_NAME: "taskflow-uploads"
  
  SECRET_KEY: "k8s-secret-key"

# --- API Deployment ---
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: taskflow-api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: taskflow-api
  template:
    metadata:
      labels:
        app: taskflow-api
    spec:
      containers:
        - name: api
          image: taskflow-api:latest
          imagePullPolicy: Never
          command: ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]
          envFrom:
            - configMapRef:
                name: taskflow-config
          ports:
            - containerPort: 8000

# --- API Service (LoadBalancer) ---
---
apiVersion: v1
kind: Service
metadata:
  name: taskflow-api-service
spec:
  type: LoadBalancer
  selector:
    app: taskflow-api
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000

# --- Worker Deployment ---
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: taskflow-worker
spec:
  replicas: 1
  selector:
    matchLabels:
      app: taskflow-worker
  template:
    metadata:
      labels:
        app: taskflow-worker
    spec:
      containers:
        - name: worker
          image: taskflow-api:latest
          imagePullPolicy: Never
          command: ["celery", "-A", "src.shared.celery_app", "worker", "--loglevel=info"]
          envFrom:
            - configMapRef:
                name: taskflow-config